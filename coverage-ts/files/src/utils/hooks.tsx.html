
  <!DOCTYPE html>
  <html>
    <head>
      <title>hooks.tsx</title>
      <link href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" type="text/css" rel="stylesheet">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/mode/javascript/javascript.min.js" type="text/javascript" charset="utf-8"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.css" type="text/css" rel="stylesheet">
<script src="../../../assets/source-file.js" type="text/javascript" charset="utf-8"></script>
<link href="../../../assets/source-file.css" type="text/css" rel="stylesheet">
    </head>
    <body>
    <div style="margin-top:3em" class="ui container"><h1 class="ui header"><a href="../../../index.html">TypeScript coverage report</a></h1><table style="margin-top:2em" class="ui celled table"><thead class=""><tr class=""><th class="">Filename</th><th class="">Percent</th><th class="">Threshold</th><th class="">Total</th><th class="">Covered</th><th class="">Uncovered</th></tr></thead><tbody class=""><tr class="negative"><td class="">src/utils/hooks.tsx</td><td class="">69.14%</td><td class="">80%</td><td class="">162</td><td class="">112</td><td class="">50</td></tr></tbody></table><textarea id="editor" readonly="" style="margin-top:3em">import { EventSourcePolyfill } from &#x27;event-source-polyfill&#x27;
import { TypedUseSelectorHook, useDispatch, useSelector } from &#x27;react-redux&#x27;
import { AppDispatch, Question, RootState } from &#x27;../types&#x27;
import { onCloseStream } from &#x27;./eventsEmitter&#x27;
import { setHeaders, setUserQuestion } from &#x27;./setData&#x27;
import { streamUrl } from &#x27;../constants/api&#x27;

export const useAppDispatch: () =&gt; AppDispatch = useDispatch
export const useAppSelector: TypedUseSelectorHook&lt;RootState&gt; = useSelector

export const useFetch = async (url: string, method: string, props): Promise&lt;any&gt; =&gt; {
  const { data, headers } = props
  try {
    const response = await fetch(url, {
      method: method,
      credentials: &#x27;include&#x27;,
      headers,
      body: data === undefined ? &#x27;&#x27; : data,
    })

    if (!response.ok) {
      throw new Error(`Fetch failed with status: ${response.status}`)
    }

    if (url.includes(&#x27;start&#x27;)) return response
    const jsonData = await response.json()
    return jsonData
  } catch (error) {
    console.error(&#x27;An error occurred: &#x27;, error)
    throw error
  }
}

function handleStreamMessage(e, dispatch, stream_chat, isChat: boolean) {
  try {
    const jsonData = JSON.parse(e.data)
    if (jsonData == &#x27;[DONE]&#x27;) {
      stream_chat.close()

      dispatch({ type: &#x27;SET_STREAM_ID&#x27;, nextStreamId: 0 })
      if (isChat) {
        dispatch({ type: &#x27;SET_CHAT_ID&#x27;, nextChatId: 0 })
      }
      return dispatch({ type: &#x27;STOP_AGENT_STREAM&#x27; })
    }
    return dispatch({ type: &#x27;GET_AGENT_STREAM&#x27;, nextResponse: jsonData })
  } catch (error) {
    console.error(&#x27;An error occurred: &#x27;, error)

    return error
  }
}

function handleStreamError(e, stream_chat) {
  if (stream_chat) {
    stream_chat.close()

    return stream_chat
  }
}

/*
 **	Manage stream
 */
export const useStream = async (dispatch, id: number, isChat: boolean) =&gt; {
  const stream_chat = new EventSourcePolyfill(`${streamUrl}/${id}/start`, {
    headers: setHeaders(true),
    withCredentials: true,
  })

  dispatch({ type: &#x27;RESET_AGENT_STREAM&#x27; })
  stream_chat.onmessage = (e) =&gt; {
    handleStreamMessage(e, dispatch, stream_chat, isChat)
  }
  stream_chat.onerror = (e) =&gt; {
    handleStreamError(e, stream_chat)
  }
  onCloseStream(() =&gt; {
    if (stream_chat) {
      stream_chat.close()
    }
    dispatch({ type: &#x27;SET_INITIAL_STREAM&#x27; })
    //dispatch({ type: &#x27;SET_CHAT_ID&#x27;, nextChatId: 0 })
  })
}

/*
 **  Generates new stream from a chatId
 */
export async function generateStream(
  question: Question,
  dispatch,
  chatId: number,
  isChat: boolean
) {
  console.log(&#x27;generateStream&#x27;)
  const headers = setHeaders(false)
  const stream_data = setUserQuestion(question)
  const stream = await useFetch(streamUrl + `/chat/${chatId}`, &#x27;POST&#x27;, {
    data: JSON.stringify(stream_data),
    headers,
  })
  dispatch({ type: &#x27;SET_STREAM_ID&#x27;, nextStreamId: stream.id })
  dispatch({ type: &#x27;SET_LAST_STREAM_ID&#x27;, nextLastStreamId: stream.id })

  await useStream(dispatch, stream.id, isChat)
}
</textarea><pre id="annotations" style="display:none">[{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:10,&quot;character&quot;:60,&quot;text&quot;:&quot;props&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:11,&quot;character&quot;:10,&quot;text&quot;:&quot;data&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:11,&quot;character&quot;:16,&quot;text&quot;:&quot;headers&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:17,&quot;character&quot;:12,&quot;text&quot;:&quot;data&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:25,&quot;character&quot;:10,&quot;text&quot;:&quot;jsonData&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:26,&quot;character&quot;:11,&quot;text&quot;:&quot;jsonData&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:28,&quot;character&quot;:41,&quot;text&quot;:&quot;error&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:29,&quot;character&quot;:10,&quot;text&quot;:&quot;error&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:27,&quot;character&quot;:11,&quot;text&quot;:&quot;error&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:33,&quot;character&quot;:29,&quot;text&quot;:&quot;e&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:33,&quot;character&quot;:32,&quot;text&quot;:&quot;dispatch&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:33,&quot;character&quot;:42,&quot;text&quot;:&quot;stream_chat&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:35,&quot;character&quot;:10,&quot;text&quot;:&quot;jsonData&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:35,&quot;character&quot;:32,&quot;text&quot;:&quot;e&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:35,&quot;character&quot;:34,&quot;text&quot;:&quot;data&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:36,&quot;character&quot;:8,&quot;text&quot;:&quot;jsonData&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:37,&quot;character&quot;:6,&quot;text&quot;:&quot;stream_chat&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:37,&quot;character&quot;:18,&quot;text&quot;:&quot;close&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:39,&quot;character&quot;:6,&quot;text&quot;:&quot;dispatch&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:41,&quot;character&quot;:8,&quot;text&quot;:&quot;dispatch&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:43,&quot;character&quot;:13,&quot;text&quot;:&quot;dispatch&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:45,&quot;character&quot;:11,&quot;text&quot;:&quot;dispatch&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:45,&quot;character&quot;:48,&quot;text&quot;:&quot;nextResponse&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:45,&quot;character&quot;:62,&quot;text&quot;:&quot;jsonData&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:47,&quot;character&quot;:41,&quot;text&quot;:&quot;error&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:49,&quot;character&quot;:11,&quot;text&quot;:&quot;error&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:46,&quot;character&quot;:11,&quot;text&quot;:&quot;error&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:53,&quot;character&quot;:27,&quot;text&quot;:&quot;e&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:53,&quot;character&quot;:30,&quot;text&quot;:&quot;stream_chat&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:54,&quot;character&quot;:6,&quot;text&quot;:&quot;stream_chat&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:55,&quot;character&quot;:4,&quot;text&quot;:&quot;stream_chat&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:55,&quot;character&quot;:16,&quot;text&quot;:&quot;close&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:57,&quot;character&quot;:11,&quot;text&quot;:&quot;stream_chat&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:64,&quot;character&quot;:32,&quot;text&quot;:&quot;dispatch&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:70,&quot;character&quot;:2,&quot;text&quot;:&quot;dispatch&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:72,&quot;character&quot;:27,&quot;text&quot;:&quot;dispatch&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:81,&quot;character&quot;:4,&quot;text&quot;:&quot;dispatch&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:91,&quot;character&quot;:2,&quot;text&quot;:&quot;dispatch&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:98,&quot;character&quot;:8,&quot;text&quot;:&quot;stream&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:102,&quot;character&quot;:2,&quot;text&quot;:&quot;dispatch&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:102,&quot;character&quot;:36,&quot;text&quot;:&quot;nextStreamId&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:102,&quot;character&quot;:50,&quot;text&quot;:&quot;stream&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:102,&quot;character&quot;:57,&quot;text&quot;:&quot;id&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:103,&quot;character&quot;:2,&quot;text&quot;:&quot;dispatch&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:103,&quot;character&quot;:41,&quot;text&quot;:&quot;nextLastStreamId&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:103,&quot;character&quot;:59,&quot;text&quot;:&quot;stream&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:103,&quot;character&quot;:66,&quot;text&quot;:&quot;id&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:105,&quot;character&quot;:18,&quot;text&quot;:&quot;dispatch&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:105,&quot;character&quot;:28,&quot;text&quot;:&quot;stream&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/utils/hooks.tsx&quot;,&quot;line&quot;:105,&quot;character&quot;:35,&quot;text&quot;:&quot;id&quot;,&quot;kind&quot;:1}]</pre></div>
    <p class="footer-text">TypeScript Coverage Report generated by <a href="https://github.com/plantain-00/type-coverage">type-coverage</a> and <a href="https://github.com/alexcanessa/typescript-coverage-report">typescript-coverage-report</a> at Wed, 28 Feb 2024 13:21:41 GMT</p>
    </body>
  </html>
  