
  <!DOCTYPE html>
  <html>
    <head>
      <title>MeetingMainResponse.tsx</title>
      <link href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css" type="text/css" rel="stylesheet">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.js" type="text/javascript" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/mode/javascript/javascript.min.js" type="text/javascript" charset="utf-8"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.2/codemirror.min.css" type="text/css" rel="stylesheet">
<script src="../../../../assets/source-file.js" type="text/javascript" charset="utf-8"></script>
<link href="../../../../assets/source-file.css" type="text/css" rel="stylesheet">
    </head>
    <body>
    <div style="margin-top:3em" class="ui container"><h1 class="ui header"><a href="../../../../index.html">TypeScript coverage report</a></h1><table style="margin-top:2em" class="ui celled table"><thead class=""><tr class=""><th class="">Filename</th><th class="">Percent</th><th class="">Threshold</th><th class="">Total</th><th class="">Covered</th><th class="">Uncovered</th></tr></thead><tbody class=""><tr class="positive"><td class="">src/components/Meeting/MeetingMainResponse.tsx</td><td class="">90.97%</td><td class="">80%</td><td class="">299</td><td class="">272</td><td class="">27</td></tr></tbody></table><textarea id="editor" readonly="" style="margin-top:3em">import { Button } from &#x27;@codegouvfr/react-dsfr/Button&#x27;
import { useContext, useEffect, useState } from &#x27;react&#x27;
import { useDispatch, useSelector } from &#x27;react-redux&#x27;
import { ArchiveType, MeetingInputContext, RootState } from &#x27;types&#x27;
import { emitCloseStream } from &#x27;utils/eventsEmitter&#x27;
import { generateStream } from &#x27;utils/hooks&#x27;
import { setQuestionWithContext } from &#x27;utils/setData&#x27;
import { CurrQuestionContext } from &#x27;../../utils/context/questionContext&#x27;
import { GlobalColContainer } from &#x27;../Global/GlobalColContainer&#x27;
import { GlobalSecondaryTitle } from &#x27;../Global/GlobalSecondaryTitle&#x27;
import { DisplaySourceCards } from &#x27;./MeetingOutputs&#x27;
import { MeetingQR } from &#x27;./MeetingQR&#x27;
import { MeetingStream } from &#x27;./MeetingStream&#x27;
import { MeetingTags } from &#x27;./MeetingTags&#x27;
import { ThemesAndAdminsInput } from &#x27;./ThemesAndAdminsInput&#x27;
/*****************************************************************************************************
	
	COMPONENTS:

		**	MeetingStream: display stream &amp; chunks from GET /indexes chunks used to generate response

		**	MeetingQR: set related questions cards from sheets informations

 *****************************************************************************************************/

export function MeetingMainResponse({ archive }: { archive: ArchiveType | undefined }) {
  const [question, setQuestion] = useState(&#x27;&#x27;)
  /*   const [feedback, setFeedback] = useState&lt;FeedbackType&gt;(InitialFeedback)
   */
  const user = useSelector((state: RootState) =&gt; state.user)
  return (
    &lt;&gt;
      &lt;DisplaySourceCards chunks={user.chunks} /&gt;
      &lt;GlobalColContainer&gt;
        &lt;MeetingStream archive={archive} /&gt;
        {/*         &lt;Feedback isFirst={true} feedback={feedback} setFeedback={setFeedback} /&gt;
         */}{&#x27; &#x27;}
        {!archive &amp;&amp; (
          &lt;NewQuestionInput questionInput={question} setQuestionInput={setQuestion} /&gt;
        )}
        &lt;MeetingQR archive={archive} setQuestion={setQuestion} /&gt;
      &lt;/GlobalColContainer&gt;
    &lt;/&gt;
  )
}

export function NewQuestionInput({ questionInput, setQuestionInput }) {
  const stream = useSelector((state: RootState) =&gt; state.stream)
  const user = useSelector((state: RootState) =&gt; state.user)
  const dispatch = useDispatch()
  const { currQuestion, updateCurrQuestion } = useContext(CurrQuestionContext)
  const [isAdditionalInputOpened, setIsAdditionalInputOpened] = useState(false)
  const [context, setContext] = useState&lt;MeetingInputContext&gt;({
    administrations: [],
    themes: [],
  })
  console.log(&#x27;question&#x27;, questionInput)
  const handleChange = (e) =&gt; {
    e.preventDefault()

    setQuestionInput(e.target.value)
  }

  useEffect(() =&gt; {
    emitCloseStream()
    generateStream(user.question, dispatch, user.chatId, false)
  }, [user.question])

  const handleSubmit = async () =&gt; {
    setIsAdditionalInputOpened(false)
    dispatch({
      type: &#x27;ADD_HISTORY&#x27;,
      newItem: {
        query: currQuestion.query,
        response: stream.historyStream[0],
        sheets: user.sheets,
        chunks: user.chunks,
        webservices: user.webservices,
      },
    })
/*     updateCurrQuestion({
      ...currQuestion,
      query: setQuestionWithContext(questionInput, context),
    }) */
    dispatch({
      type: &#x27;SET_USER_QUERY&#x27;,
      nextUserQuery: questionInput,
      nextChatId: user.chatId,
    })
    stream.historyStream.length &amp;&amp;
      dispatch({
        type: &#x27;SET_MESSAGES&#x27;,
        nextMessage: { text: stream.historyStream, sender: &#x27;agent&#x27; },
      })
    dispatch({ type: &#x27;RESET_STREAM_HISTORY&#x27; })
    dispatch({
      type: &#x27;SET_MESSAGES&#x27;,
      nextMessage: { text: questionInput, sender: &#x27;user&#x27; },
    })
    console.log(&#x27;dispatchNewQuestion&#x27;, user.question.query, currQuestion)

    setQuestionInput(&#x27;&#x27;)
  }
  /*   useEffect(() =&gt; {
    console.log(&#x27;useffect MAINREPONSE&#x27;)
    if (user.chatId &amp;&amp; !stream.isStreaming) {
      emitCloseStream()
      generateStream(currQuestion, dispatch, user.chatId, false)
    }
  }, [user.question]) */
  function handleKeyDown(e: any) {
    if (e.key === &#x27;Enter&#x27; &amp;&amp; questionInput !== &#x27;&#x27; &amp;&amp; !stream.isStreaming) {
      handleSubmit()
    }
  }

  return (
    &lt;div&gt;
      &lt;div className=&quot; w-full &quot;&gt;
        &lt;GlobalSecondaryTitle extraClass=&quot;fr-mt-4w fr-mb-2w&quot;&gt;
          Poser une question complémentaire
        &lt;/GlobalSecondaryTitle&gt;
        &lt;textarea
          style={{ minHeight: &#x27;10px&#x27; }}
          placeholder=&quot;Poser une nouvelle question&quot;
          rows={1}
          onChange={handleChange}
          value={questionInput}
          onKeyDown={handleKeyDown}
          className=&quot;fr-input justify-end&quot;
          id=&quot;textarea&quot;
          name=&quot;textarea&quot;
        &gt;&lt;/textarea&gt;
      &lt;/div&gt;
      {isAdditionalInputOpened &amp;&amp; (
        &lt;NewQuestionMeetingAdditionalInput context={context} setContext={setContext} /&gt;
      )}
      &lt;div className=&quot;flex justify-between&quot;&gt;
        &lt;Button
          onClick={() =&gt; setIsAdditionalInputOpened(!isAdditionalInputOpened)}
          disabled={stream.isStreaming}
          className=&quot;fr-btn&quot;
          title=&quot;Rechercher&quot;
          iconId={
            isAdditionalInputOpened ? &#x27;fr-icon-arrow-up-s-line&#x27; : &#x27;fr-icon-add-line&#x27;
          }
        &gt;&lt;/Button&gt;
        &lt;Button
          onClick={handleSubmit}
          disabled={questionInput === &#x27;&#x27; || stream.isStreaming}
          className=&quot;fr-btn&quot;
          title=&quot;Rechercher&quot;
          iconId=&quot;fr-icon-search-line&quot;
        &gt;
          Rechercher
        &lt;/Button&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  )
}

export function NewQuestionMeetingAdditionalInput({
  context,
  setContext,
}: {
  context: MeetingInputContext
  setContext: React.Dispatch&lt;React.SetStateAction&lt;MeetingInputContext&gt;&gt;
}) {
  const handleSetTag = (tag, fieldName) =&gt; {
    if (fieldName === &#x27;administrations&#x27;)
      setContext((prevContext) =&gt; ({
        ...prevContext,
        administrations: [...prevContext.administrations, tag],
      }))
    else if (fieldName === &#x27;themes&#x27;)
      setContext((prevContext) =&gt; ({
        ...prevContext,
        themes: [...prevContext.themes, tag],
      }))
  }

  return (
    &lt;div className=&quot;fr-mt-2w fr-grid-row gap-8&quot;&gt;
      {inputFields.map((field, index) =&gt; {
        const tags = field.name === &#x27;themes&#x27; ? context.themes : context.administrations
        return (
          &lt;div className=&quot;fr-col-5&quot; key={index}&gt;
            &lt;ThemesAndAdminsInput
              field={field}
              onTagSelect={(tag) =&gt; handleSetTag(tag, field.name)}
              themes={context.themes}
              administrations={context.administrations}
            /&gt;
            &lt;MeetingTags
              setContext={setContext}
              context={context}
              field={field}
              tags={tags}
            /&gt;
          &lt;/div&gt;
        )
      })}
    &lt;/div&gt;
  )
}

export const inputFields = [
  {
    label: &#x27;Thèmes associés&#x27;,
    name: &#x27;themes&#x27;,
    className: &#x27;fr-mr-1w&#x27;,
  },
  {
    label: &#x27;Opérateurs concernés&#x27;,
    name: &#x27;administrations&#x27;,
    className: &#x27;fr-mr-1w&#x27;,
  },
]
</textarea><pre id="annotations" style="display:none">[{&quot;file&quot;:&quot;src/components/Meeting/MeetingMainResponse.tsx&quot;,&quot;line&quot;:46,&quot;character&quot;:35,&quot;text&quot;:&quot;questionInput&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/components/Meeting/MeetingMainResponse.tsx&quot;,&quot;line&quot;:46,&quot;character&quot;:50,&quot;text&quot;:&quot;setQuestionInput&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/components/Meeting/MeetingMainResponse.tsx&quot;,&quot;line&quot;:56,&quot;character&quot;:26,&quot;text&quot;:&quot;questionInput&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/components/Meeting/MeetingMainResponse.tsx&quot;,&quot;line&quot;:57,&quot;character&quot;:24,&quot;text&quot;:&quot;e&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/components/Meeting/MeetingMainResponse.tsx&quot;,&quot;line&quot;:58,&quot;character&quot;:4,&quot;text&quot;:&quot;e&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/components/Meeting/MeetingMainResponse.tsx&quot;,&quot;line&quot;:58,&quot;character&quot;:6,&quot;text&quot;:&quot;preventDefault&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/components/Meeting/MeetingMainResponse.tsx&quot;,&quot;line&quot;:60,&quot;character&quot;:4,&quot;text&quot;:&quot;setQuestionInput&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/components/Meeting/MeetingMainResponse.tsx&quot;,&quot;line&quot;:60,&quot;character&quot;:21,&quot;text&quot;:&quot;e&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/components/Meeting/MeetingMainResponse.tsx&quot;,&quot;line&quot;:60,&quot;character&quot;:23,&quot;text&quot;:&quot;target&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/components/Meeting/MeetingMainResponse.tsx&quot;,&quot;line&quot;:60,&quot;character&quot;:30,&quot;text&quot;:&quot;value&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/components/Meeting/MeetingMainResponse.tsx&quot;,&quot;line&quot;:74,&quot;character&quot;:8,&quot;text&quot;:&quot;response&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/components/Meeting/MeetingMainResponse.tsx&quot;,&quot;line&quot;:86,&quot;character&quot;:6,&quot;text&quot;:&quot;nextUserQuery&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/components/Meeting/MeetingMainResponse.tsx&quot;,&quot;line&quot;:86,&quot;character&quot;:21,&quot;text&quot;:&quot;questionInput&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/components/Meeting/MeetingMainResponse.tsx&quot;,&quot;line&quot;:97,&quot;character&quot;:21,&quot;text&quot;:&quot;text&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/components/Meeting/MeetingMainResponse.tsx&quot;,&quot;line&quot;:97,&quot;character&quot;:27,&quot;text&quot;:&quot;questionInput&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/components/Meeting/MeetingMainResponse.tsx&quot;,&quot;line&quot;:101,&quot;character&quot;:4,&quot;text&quot;:&quot;setQuestionInput&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/components/Meeting/MeetingMainResponse.tsx&quot;,&quot;line&quot;:110,&quot;character&quot;:25,&quot;text&quot;:&quot;e&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/components/Meeting/MeetingMainResponse.tsx&quot;,&quot;line&quot;:111,&quot;character&quot;:8,&quot;text&quot;:&quot;e&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/components/Meeting/MeetingMainResponse.tsx&quot;,&quot;line&quot;:111,&quot;character&quot;:10,&quot;text&quot;:&quot;key&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/components/Meeting/MeetingMainResponse.tsx&quot;,&quot;line&quot;:111,&quot;character&quot;:29,&quot;text&quot;:&quot;questionInput&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/components/Meeting/MeetingMainResponse.tsx&quot;,&quot;line&quot;:149,&quot;character&quot;:20,&quot;text&quot;:&quot;questionInput&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/components/Meeting/MeetingMainResponse.tsx&quot;,&quot;line&quot;:168,&quot;character&quot;:24,&quot;text&quot;:&quot;tag&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/components/Meeting/MeetingMainResponse.tsx&quot;,&quot;line&quot;:168,&quot;character&quot;:29,&quot;text&quot;:&quot;fieldName&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/components/Meeting/MeetingMainResponse.tsx&quot;,&quot;line&quot;:169,&quot;character&quot;:8,&quot;text&quot;:&quot;fieldName&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/components/Meeting/MeetingMainResponse.tsx&quot;,&quot;line&quot;:174,&quot;character&quot;:13,&quot;text&quot;:&quot;fieldName&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/components/Meeting/MeetingMainResponse.tsx&quot;,&quot;line&quot;:189,&quot;character&quot;:28,&quot;text&quot;:&quot;tag&quot;,&quot;kind&quot;:1},{&quot;file&quot;:&quot;src/components/Meeting/MeetingMainResponse.tsx&quot;,&quot;line&quot;:189,&quot;character&quot;:49,&quot;text&quot;:&quot;tag&quot;,&quot;kind&quot;:1}]</pre></div>
    <p class="footer-text">TypeScript Coverage Report generated by <a href="https://github.com/plantain-00/type-coverage">type-coverage</a> and <a href="https://github.com/alexcanessa/typescript-coverage-report">typescript-coverage-report</a> at Wed, 28 Feb 2024 13:21:41 GMT</p>
    </body>
  </html>
  